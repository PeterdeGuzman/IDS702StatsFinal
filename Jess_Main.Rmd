---
title: "Jess_Main"
output: pdf_document
date: "2024-12-08"
---

```{r}
# Load necessary libraries
library(dplyr)   # Provides %>% and mutate
library(tidyverse)  # Optionally load the entire tidyverse if needed
library(pROC)
```

```{r}
file_path <- "/Users/nakiyahdhariwala/StatsProject/39096-0001-Data.rda"

load(file_path)          # Load the RDA file
ls()                     # List objects loaded into the environment
dataset <- da39096.0001  # Access the dataset

head(dataset)
ncol(dataset)
nrow(dataset)
```

```{r}
# Calculate proportions
proportions <- prop.table(table(dataset$Q1R5))
proportions
# Define custom labels
custom_labels <- c("Not important", "Important", "Not ")

# Combine custom labels with percentages
pie_labels <- paste(custom_labels, round(proportions * 100, 2), "%")

# Plot the pie chart with custom labels
pie(proportions,
    labels = pie_labels,
    main = "Q1R5: Stopping discrimination against racial/ethnic minorities",
    col = c("lightblue", "salmon"))
```

```{r}
# Define the required columns
required_cols <- c(
  # Outcome Variable: Stopping discrimination against racial/ethnic minorities
  "Q1R5", 

  # Demographic Variables
  "S2_RACE_PRIME",   # Primary Race
  "S3",              # SexualOrientation
  "S3B",             # Gender
  "S5_AGE",          # Age categories
  "S13",             # Highest level of education
  "S14",             # Community lived in

  # Variables capturing experiences with racism
  "Q629R1",          # Unfair treatment due to racial background/ethnicity
  "Q629R2",          # Unfair treatment due to skin color
  "Q629R3",          # Unfair treatment due to gender
  "Q629R4",          # Unfair treatment due to sexuality/orientation
  "Q629R5",          # Unfair treatment due to immigration status
  "Q629R6",          # Unfair treatment due to religion
  "Q629R7",          # Unfair treatment due to accent

  "Q627",            # Treated unfairly or discriminated against because of your race, ethnicity, gender, sexuality, being an immigrant, religious heritage or having an accent?
  "Q633",            # Discrimination impact on life satisfaction

  # Religion-related variables
  "Q58R1", "Q58R2", "Q58R3", "Q58R4", "Q58R5", "Q58R6", "Q58R7", 
  "Q58R8", "Q58R9", "Q58R10", "Q58R11", "Q58R12", "Q58R13", 
  "Q58R14", "Q58R15", # Various religious affiliations

  # Perceptions of discrimination
  "Q619_Q626R1",     # Perceptions of discrimination against Whites
  "Q619_Q626R2",     # Perceptions of discrimination against Blacks
  "Q619_Q626R3",     # Perceptions of discrimination against Asian Americans
  "Q619_Q626R4",     # Perceptions of discrimination against Native Americans
  "Q619_Q626R5",     # Perceptions of discrimination against Immigrants
  "Q619_Q626R6",     # Perceptions of discrimination against Latinos
  "Q619_Q626R7",     # Perceptions of discrimination against GaysAndLesbians
  "Q619_Q626R8"      # Perceptions of discrimination against Muslims
)
```

```{r}
# Create a new dataframe with selected variables
dataset_new <- dataset[, required_cols]

# Recode the outcome variable 'Q1R5' for readability
dataset_new$Q1R5 <- factor(
  ifelse(
    dataset_new$Q1R5 == "(0) NO TO: Stopping discrimination against racial/ethnic minorities", 
    "Not important",
    "Important"  # Remaining cases are "Important"
  ),
  levels = c("Not important", "Important") # Define factor levels
)

# Define the columns for perceptions of discrimination
perception_cols <- c(
  "Q619_Q626R1",  # Perceptions of discrimination against Whites
  "Q619_Q626R2",  # Perceptions of discrimination against Blacks
  "Q619_Q626R3",  # Perceptions of discrimination against Asian Americans
  "Q619_Q626R4",  # Perceptions of discrimination against Native Americans
  "Q619_Q626R5",  # Perceptions of discrimination against Immigrants
  "Q619_Q626R6",  # Perceptions of discrimination against Latinos
  "Q619_Q626R7",  # Perceptions of discrimination against GaysAndLesbians
  "Q619_Q626R8",  # Perceptions of discrimination against Muslims
  "Q633"          # Discrimination impact on life satisfaction
)

# Recode 'Don' as 'Don't know' and ensure columns remain factors
dataset_new[perception_cols] <- lapply(dataset_new[perception_cols], function(x) {
  x <- as.character(x)  # Temporarily convert to character for recoding
  x <- ifelse(x == "(5) Don", "(5) Don't know", x)  # Recode 'Don' to 'Don't know'
  factor(x)  # Convert back to factor
})

# Verify the changes in perception columns
head(dataset_new[perception_cols])

# Define required columns to convert to factors (if not already defined)
# Assuming `required_cols` is previously defined; otherwise, specify explicitly
dataset_new[required_cols] <- lapply(dataset_new[required_cols], as.factor)

# Verify the structure of the dataset
str(dataset_new[required_cols])

# Display the first few rows to check the changes
head(dataset_new)

```

```{r}
# Data Cleaning and Recoding for dataset_new
dataset_new <- dataset_new %>% 
  mutate(
    # Education recoding
    educ = case_when(
      S13 == "(1) Grades 1-8" ~ "No college experience",
      S13 == "(2) Some High School, but did not graduate" ~ "No college experience",
      S13 == "(3) High School graduate or GED" ~ "No college experience",
      S13 == "(4) Some college" ~ "Some college experience",
      S13 == "(5) Associates, 2-year degree" ~ "College graduate",
      S13 == "(6) Bachelors, 4-year degree" ~ "College graduate",
      S13 == "(7) Post-graduate degree" ~ "College graduate"
    ),
    # Sexual orientation recoding
    sex_orientation = case_when(
      S3 == "(01) Straight, that is, not gay or lesbian" ~ "Straight",
      S3 == "(02) Gay or lesbian" ~ "Queer",
      S3 == "(03) Bisexual" ~ "Queer",
      S3 == "(04) Something else (Specify)" ~ "Queer",
      S3 == "(88) Refused" ~ "Refused/Don't Know",
      S3 == "(99) I don" ~ "Refused/Don't Know"
    ),
    # Urban vs rural recoding
    rural = case_when(
      S14 == "(1) Large urban area" ~ "Urban/suburban",
      S14 == "(2) Large suburb near large city" ~ "Urban/suburban",
      S14 == "(3) Small suburb near small town or city" ~ "Urban/suburban",
      S14 == "(4) Small town or small city" ~ "Urban/suburban",
      S14 == "(5) Rural area" ~ "Rural"
    ),
    # Race recoding
    race_recoded = case_when(
      S2_RACE_PRIME == "(1) White" ~ "White",
      S2_RACE_PRIME == "(2) Hispanic or Latino" ~ "Latino",
      S2_RACE_PRIME == "(3) Black or African American" ~ "Black",
      S2_RACE_PRIME == "(4) Asian American" ~ "Asian American",
      S2_RACE_PRIME == "(5) American Indian/Native American" ~ "AIAN",
      S2_RACE_PRIME == "(6) Arab, Middle Eastern or North African" ~ "Arab/MENA",
      S2_RACE_PRIME == "(7) Native Hawaiian" ~ "NHPI",
      S2_RACE_PRIME == "(8) Not Hawaiian, but other Pacific Islander" ~ "NHPI"
    ),
    # Age recoding
    age_recoded = case_when(
      S5_AGE == "(1) 16-17" ~ "16-17",
      S5_AGE == "(2) 18-29" ~ "18-29",
      S5_AGE == "(3) 30-39" ~ "30-39",
      S5_AGE == "(4) 40-49" ~ "40-49",
      S5_AGE == "(5) 50-59" ~ "50-59",
      S5_AGE == "(6) 60-69" ~ "60-69",
      S5_AGE == "(7) 70 +" ~ "70+"
    )
  ) %>%
  mutate(
    # Converting variables to factors
    race_recoded = factor(race_recoded, levels = c("White", "Black", "Asian American", "Latino", "AIAN", "NHPI", "Arab/MENA")),
    age_recoded = factor(age_recoded, levels = c("18-29", "30-39", "40-49", "50-59", "60-69", "70+")),
    educ = factor(educ, levels = c("No college experience", "Some college experience", "College graduate")),
    rural = factor(rural, levels = c("Rural", "Urban/suburban")),
    sex_orientation = factor(sex_orientation, levels = c("Straight", "Queer", "Refused/Don't Know"))
  )

# Convert individual religion columns to numeric
for (i in 1:15) {
  col_name <- paste0("Q58R", i, "_numeric")
  dataset_new[[col_name]] <- as.numeric(sub("^\\((\\d+)\\).*", "\\1", dataset_new[[paste0("Q58R", i)]]))
}

# Create a new Religion variable
dataset_new$Religion <- "None"

# Assign religion based on the numeric values of each Q58R column
religion_mapping <- c(
  "Q58R1_numeric" = "Catholic", 
  "Q58R2_numeric" = "Protestant", 
  "Q58R3_numeric" = "Other Christian",
  "Q58R4_numeric" = "Jewish", 
  "Q58R5_numeric" = "Muslim", 
  "Q58R6_numeric" = "Hindu", 
  "Q58R7_numeric" = "Buddhist", 
  "Q58R8_numeric" = "Mormon/LDS", 
  "Q58R9_numeric" = "Folk Religion", 
  "Q58R10_numeric" = "Daoist", 
  "Q58R11_numeric" = "Shamanism", 
  "Q58R12_numeric" = "Ancestral Religion", 
  "Q58R13_numeric" = "Spiritual but not religious", 
  "Q58R14_numeric" = "Atheist", 
  "Q58R15_numeric" = "Agnostic"
)

# Loop through the mapping to assign religion values
for (col in names(religion_mapping)) {
  dataset_new$Religion[dataset_new[[col]] == 1] <- religion_mapping[[col]]
}

# Handle multiple religious affiliations
dataset_new$Religion[rowSums(dataset_new[, grep("_numeric", names(dataset_new))] == 1) > 1] <- "Multiple Religions"

# Convert Religion to a factor with specific levels
dataset_new$Religion <- factor(dataset_new$Religion,
                               levels = c("Catholic", "Protestant", "Other Christian", "Jewish", "Muslim",
                                          "Hindu", "Buddhist", "Mormon/LDS", "Folk Religion",
                                          "Daoist", "Shamanism", "Ancestral Religion",
                                          "Spiritual but not religious", "Atheist", "Agnostic", 
                                          "Multiple Religions", "None"))

# Remove redundant religion columns
redundant_cols <- c(
  paste0("Q58R", 1:15), paste0("Q58R", 1:15, "_numeric")
)

# Remove redundant columns from the dataset
dataset_clean <- dataset_new[, !(names(dataset_new) %in% redundant_cols)]

# Take a look at the updated dataset
head(dataset_clean)

```

```{r}
# Check the number of missing values for each variable
missing_summary <- sapply(dataset_clean, function(x) sum(is.na(x)))

# Create a data frame to display the missing values clearly
missing_df <- data.frame(Variable = names(missing_summary), Missing_Count = missing_summary)
print(missing_df)

# Extract the variables Q629R1 to Q629R7
racism_vars <- dataset_clean[, grep("^Q629R[1-7]$", names(dataset_clean))]

# Calculate the proportion of missing values for each variable
missing_proportions <- colSums(is.na(racism_vars)) / nrow(racism_vars)

# Convert to a data frame
missing_summary <- data.frame(Variable = names(missing_proportions),
                              Missing_Proportion = round(missing_proportions, 4))

print(missing_summary)
```

```{r}
# Remove the variables Q629R1 to Q629R7
dataset_clean <- dataset_clean[, !(names(dataset_clean) %in% c("Q629R1", "Q629R2", 
                                                               "Q629R3", "Q629R4", 
                                                               "Q629R5", "Q629R6", "Q629R7"))]

head(dataset_clean)
```

```{r}
# List of redundant columns to remove
redundant_cols <- c("S2_RACE_PRIME", "S13", "S3", "S5_AGE","S14")

# Remove the redundant columns
dataset_clean <- dataset_clean %>% select(-all_of(redundant_cols))

# Verify the resulting dataset
colnames(dataset_clean)

```

```{r}
  # Rename columns in dataset_clean
colnames(dataset_clean) <- c(
  "ImportanceOfStoppingDiscriminationAgainstMinorities",  # Q1R5
  "Gender",                                              # S3B
  "CommunityLivedIn",                                    # S14
  "DiscriminationImpactOnLifeSatisfaction",              # Q633
  "PerceptionsOfDiscriminationAgainstWhites",            # Q619_Q626R1
  "PerceptionsOfDiscriminationAgainstBlacks",            # Q619_Q626R2
  "PerceptionsOfDiscriminationAgainstAsianAmericans",    # Q619_Q626R3
  "PerceptionsOfDiscriminationAgainstNativeAmericans",   # Q619_Q626R4
  "PerceptionsOfDiscriminationAgainstImmigrants",        # Q619_Q626R5
  "PerceptionsOfDiscriminationAgainstLatinos",           # Q619_Q626R6
  "PerceptionsOfDiscriminationAgainstGaysAndLesbians",   # Q619_Q626R7
  "PerceptionsOfDiscriminationAgainstMuslims",           # Q619_Q626R8
  "Educ",                                                # educ
  "SexOrientation",                                      # sex_orientation
  "Rural",                                               # rural
  "RaceRecoded",                                         # race_recoded
  "AgeRecoded",                                          # age_recoded
  "Religion"                                             # Religion
)

# Verify the renamed columns
colnames(dataset_clean)

```

# model

```{r}
library(vcd)

library(car)
```

```{r}
# Adjusted model without `TreatedUnfairlyOrDiscriminatedAgainst`
model <- glm(ImportanceOfStoppingDiscriminationAgainstMinorities ~ RaceRecoded +
               SexOrientation + Gender + AgeRecoded + 
               Educ + CommunityLivedIn + 
               DiscriminationImpactOnLifeSatisfaction + 
               PerceptionsOfDiscriminationAgainstWhites + 
               PerceptionsOfDiscriminationAgainstBlacks +
               PerceptionsOfDiscriminationAgainstAsianAmericans + 
               PerceptionsOfDiscriminationAgainstNativeAmericans + 
               PerceptionsOfDiscriminationAgainstImmigrants + 
               PerceptionsOfDiscriminationAgainstLatinos + 
               PerceptionsOfDiscriminationAgainstGaysAndLesbians + 
               PerceptionsOfDiscriminationAgainstMuslims +
               Religion, 
             
             data = dataset_clean, family = "binomial")

```

```{r}
# Check multicollinearity using VIF
vif(model)
```

```{r}
# Perform stepwise selection
model_stepwise <- step(model, 
                       direction = "both",
                       trace = 0)
```

```{r}
# Check multicollinearity using VIF
vif(model_stepwise)
```

```{r}
# Extract odds ratios
odds_ratios <- exp(coef(model_stepwise))

# Get confidence intervals for coefficients
conf_intervals <- exp(confint(model_stepwise))

# Extract p-values
p_values <- summary(model_stepwise)$coefficients[, 4]

# Combine everything into a single data frame
results_model_stepwise <- data.frame(
  OddsRatio = odds_ratios,
  LowerCI = conf_intervals[, 1],
  UpperCI = conf_intervals[, 2],
  PValue = p_values
)

# Display results
results_model_stepwise
```

```{r}
# Filter for significant variables (p-value < 0.05)
significant_data <- results_model_stepwise[results_model_stepwise$PValue < 0.05, ]

# Add a column for variable names to use in the plot
significant_data <- significant_data %>% 
  mutate(Variable = rownames(significant_data))

# Create the plot
ggplot(significant_data, aes(x = OddsRatio, y = reorder(Variable, OddsRatio))) +
  geom_point(size = 4, color = "blue") +  # Add points for odds ratios
  geom_errorbarh(aes(xmin = LowerCI, xmax = UpperCI), height = 0.3, color = "black") +  # Add horizontal error bars
  geom_vline(xintercept = 1, linetype = "dashed", color = "red", size = 0.7) +  # Add a vertical reference line at Odds Ratio = 1
  labs(
    title = "Significant Variables with Confidence Intervals (Odds Ratio)",
    x = "Odds Ratio",
    y = "Variables"
  ) +
  theme_minimal() +  # Use a minimal theme for better aesthetics
  theme(
    axis.text.y = element_text(size = 10, color = "black"),  # Improve y-axis text readability
    axis.title.x = element_text(size = 12, face = "bold"),  # Highlight x-axis title
    axis.title.y = element_text(size = 12, face = "bold"),  # Highlight y-axis title
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),  # Center the title
    plot.margin = margin(1, 1, 1, 1, "cm")  # Adjust margins
  )

# Save the plot with larger dimensions
ggsave("Significant_Variables_Plot_Enhanced.png", width = 20, height = 10)

```

```{r}
# Set seed for reproducibility
set.seed(123)

# Split data into training (70%) and testing (30%)
library(caret)
train_index <- createDataPartition(dataset_clean$ImportanceOfStoppingDiscriminationAgainstMinorities, p = 0.7, list = FALSE)
train_data <- dataset_clean[train_index, ]
test_data <- dataset_clean[-train_index, ]

# Train stepwise logistic regression model on training data
library(MASS)  # Required for stepAIC if used in stepwise selection

# Fit the initial model (full model)
full_model <- glm(ImportanceOfStoppingDiscriminationAgainstMinorities ~ ., 
                  data = train_data, family = "binomial")

# Perform stepwise selection
final_model_stepwise <- stepAIC(full_model, direction = "both", trace = FALSE)

# Generate predictions on the test data
predicted_probs_stepwise <- predict(final_model_stepwise, newdata = test_data, type = "response")

# Convert probabilities to binary outcomes using a threshold (e.g., 0.5)
predicted_classes_stepwise <- ifelse(predicted_probs_stepwise > 0.5, "Important", "Not important")

# Ensure levels match
predicted_classes_stepwise <- factor(predicted_classes_stepwise, levels = c("Not important", "Important"))
actual_classes_stepwise <- factor(test_data$ImportanceOfStoppingDiscriminationAgainstMinorities, 
                                  levels = c("Not important", "Important"))

# Create confusion matrix
conf_matrix_stepwise <- confusionMatrix(predicted_classes_stepwise, actual_classes_stepwise)

# Print the confusion matrix
print(conf_matrix_stepwise)

```

-   The model is heavily biased toward predicting the majority class ("Not important"), as indicated by the high sensitivity but very low specificity.

-   While the overall accuracy is decent, it is largely influenced by the majority class prevalence.

-   The specificity (16.83%) suggests poor performance in identifying minority class instances ("Important").

```{r}
# Calculate the ROC curve
roc_curve <- roc(test_data$ImportanceOfStoppingDiscriminationAgainstMinorities, 
                 predicted_probs_stepwise, 
                 levels = c("Not important", "Important"))

# Print the AUC
auc_value <- auc(roc_curve)
cat("AUC:", auc_value, "\n")

# Plot the ROC curve
plot(roc_curve, col = "blue", main = "ROC Curve")
abline(a = 0, b = 1, col = "red", lty = 2)  # Add diagonal line for random guess

# Save the ROC plot
ggsave("roc_curve_plot.png", width = 8, height = 6)

```

1.  **AUC Value (0.7187)**:

    -   This is above the threshold of 0.7, which indicates acceptable discrimination ability.

    -   However, it’s not in the "excellent" range (\>0.9). The model still struggles with distinguishing between the classes, likely due to the class imbalance and overlap in predictors.

2.  **ROC Curve**:

    -   The curve is above the diagonal (random guess), which reflects the model's ability to predict better than chance.

    -   The closer the curve gets to the top-left corner, the better the performance.

### 
